#!/bin/bash
# SKR3 Flash Script
# Target: {{ grblhal_board }} ({{ grblhal_mcu }})
# Flash Tool: dfu-util (USB bootloader)

set -e

BUILD_DIR="{{ grblhal_build_dir }}"
DFU_ADDRESS="0x08020000"  # Flash address for 128KB bootloader

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}SKR3 Flash Script (DFU)${NC}"
echo -e "${GREEN}Target Board: {{ grblhal_board }}${NC}"
echo -e "${GREEN}MCU: {{ grblhal_mcu }}${NC}"
echo -e "${GREEN}Flash Address: ${DFU_ADDRESS}${NC}"
echo -e "${GREEN}======================================${NC}"
echo

# Check if dfu-util is installed
if ! command -v dfu-util &> /dev/null; then
    echo -e "${RED}ERROR: dfu-util not found!${NC}"
    echo -e "${YELLOW}Please install dfu-util:${NC}"
    echo -e "${YELLOW}  sudo apt install dfu-util${NC}"
    exit 1
fi

# Determine firmware file
if [ -n "$1" ]; then
    FIRMWARE="$1"
    if [ ! -f "$FIRMWARE" ]; then
        echo -e "${RED}ERROR: Specified firmware file not found: $FIRMWARE${NC}"
        exit 1
    fi
else
    FIRMWARE="$BUILD_DIR/firmware_latest.bin"
    if [ ! -f "$FIRMWARE" ]; then
        echo -e "${RED}ERROR: No firmware found at: $FIRMWARE${NC}"
        echo -e "${YELLOW}Please build the firmware first with: skr3-build${NC}"
        echo -e "${YELLOW}Or specify a firmware file: $0 [firmware.bin]${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}Firmware: $FIRMWARE${NC}"

# Check firmware size
SIZE=$(stat -c%s "$FIRMWARE" 2>/dev/null || stat -f%z "$FIRMWARE" 2>/dev/null)
echo -e "${GREEN}Firmware size: $SIZE bytes ($(($SIZE / 1024)) KB)${NC}"
echo

# Check if board is already in DFU mode
if dfu-util -l 2>/dev/null | grep -q "0483:df11"; then
    echo -e "${GREEN}✓ Board is already in DFU bootloader mode!${NC}"
    echo
else
    # Interactive instructions to enter DFU mode
    echo -e "${CYAN}${BOLD}═══════════════════════════════════════${NC}"
    echo -e "${CYAN}${BOLD}  Enter DFU Bootloader Mode${NC}"
    echo -e "${CYAN}${BOLD}═══════════════════════════════════════${NC}"
    echo
    echo -e "${YELLOW}Please follow these steps on your BTT SKR 3 board:${NC}"
    echo
    echo -e "${BOLD}Step 1:${NC} Locate the ${GREEN}BOOT0${NC} and ${GREEN}RESET${NC} buttons on the board"
    echo -e "        ${BLUE}Press any key when ready...${NC}"
    read -n 1 -s
    echo
    
    echo -e "${BOLD}Step 2:${NC} ${YELLOW}HOLD DOWN${NC} the ${GREEN}BOOT0${NC} button"
    echo -e "        ${BLUE}Press any key when you're holding BOOT0...${NC}"
    read -n 1 -s
    echo
    
    echo -e "${BOLD}Step 3:${NC} While holding ${GREEN}BOOT0${NC}, ${YELLOW}PRESS and RELEASE${NC} the ${GREEN}RESET${NC} button"
    echo -e "        ${BLUE}Press any key when you've pressed RESET...${NC}"
    read -n 1 -s
    echo
    
    echo -e "${BOLD}Step 4:${NC} ${YELLOW}RELEASE${NC} the ${GREEN}BOOT0${NC} button"
    echo -e "        ${BLUE}Press any key when you've released BOOT0...${NC}"
    read -n 1 -s
    echo
    
    # Give the board a moment to enumerate
    echo -e "${YELLOW}Waiting for DFU device to enumerate...${NC}"
    sleep 2
    
    # Check if board is now in DFU mode
    echo -e "${YELLOW}Checking for DFU device...${NC}"
    if ! dfu-util -l 2>/dev/null | grep -q "0483:df11"; then
        echo -e "${RED}ERROR: Board is not in DFU mode!${NC}"
        echo
        echo -e "${YELLOW}Troubleshooting:${NC}"
        echo -e "  1. Make sure USB cable is connected"
        echo -e "  2. Try the BOOT0/RESET sequence again"
        echo -e "  3. Check: lsusb (should show 0483:df11)"
        echo
        echo -e "${YELLOW}Run the script again to retry.${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✓ DFU device detected!${NC}"
    echo
fi

# Show DFU device information
echo -e "${BLUE}DFU Device Information:${NC}"
dfu-util -l 2>/dev/null | grep -A 1 "0483:df11" | head -3
echo

# Flash the firmware
echo -e "${CYAN}${BOLD}═══════════════════════════════════════${NC}"
echo -e "${CYAN}${BOLD}  Flashing Firmware${NC}"
echo -e "${CYAN}${BOLD}═══════════════════════════════════════${NC}"
echo
echo -e "${YELLOW}Starting flash operation...${NC}"
echo

# Flash without :leave to avoid the error
dfu-util -a 0 -s ${DFU_ADDRESS} -D "$FIRMWARE"

FLASH_RESULT=$?

if [ $FLASH_RESULT -eq 0 ]; then
    echo
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════${NC}"
    echo -e "${GREEN}${BOLD}  Flash Complete! ✓${NC}"
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════${NC}"
    echo
    
    # Interactive reset instructions
    echo -e "${YELLOW}To start the new firmware:${NC}"
    echo
    echo -e "${BOLD}Press the ${GREEN}RESET${NC} button on the board${NC}"
    echo -e "        ${BLUE}Press any key after you've pressed RESET...${NC}"
    read -n 1 -s
    echo
    
    echo -e "${YELLOW}Waiting for board to restart...${NC}"
    sleep 3
    
    # Check if board is running firmware
    if lsusb 2>/dev/null | grep -q "0483:5740"; then
        echo -e "${GREEN}✓ Board is running! (Virtual COM Port detected)${NC}"
        
        # Find the serial device
        SERIAL_DEV=$(ls /dev/ttyACM* 2>/dev/null | head -1)
        if [ -n "$SERIAL_DEV" ]; then
            echo -e "${GREEN}✓ Serial device: ${SERIAL_DEV}${NC}"
        fi
        echo
        echo -e "${CYAN}You can now connect to grblHAL via ${SERIAL_DEV}${NC}"
    else
        echo -e "${YELLOW}Note: Board may still be starting up or in DFU mode${NC}"
        echo -e "${YELLOW}Check with: lsusb (should show 0483:5740 for running firmware)${NC}"
    fi
    
    echo
else
    echo
    echo -e "${RED}${BOLD}═══════════════════════════════════════${NC}"
    echo -e "${RED}${BOLD}  Flash Failed! ✗${NC}"
    echo -e "${RED}${BOLD}═══════════════════════════════════════${NC}"
    echo
    echo -e "${YELLOW}Try running the script again.${NC}"
    exit 1
fi
