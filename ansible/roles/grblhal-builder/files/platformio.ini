# PlatformIO configuration for grblHAL on BTT SKR 3
# Managed by Ansible - ansible/roles/grblhal-builder
# 
# This is a simplified configuration containing only the BTT SKR3 board environment.
# Machine-specific settings are configured in Inc/my_machine.h
# For full upstream configuration, see: https://github.com/grblHAL/STM32H7xx

[platformio]
include_dir = Inc
src_dir = Src

# Common build settings that apply to all environments
[common]
build_flags =
  -I .
  -I Inc
  -I boards
  # STM32 HAL Driver includes
  -I Drivers/CMSIS/Include
  -I Drivers/CMSIS/Device/ST/STM32H7xx/Include
  -I Drivers/STM32H7xx_HAL_Driver/Inc
  -I Drivers/STM32H7xx_HAL_Driver/Inc/Legacy
  # Enable L1 cache and associated cache maintenance functions
  -D L1_CACHE_ENABLE=1
  # Enable floating point support for printf/scanf
  -Wl,-u,_printf_float
  -Wl,-u,_scanf_float
  # Run ISR code from ITCM RAM
 '-D ISR_CODE=__attribute__((section(".itcmram")))'
lib_deps =
  grbl
  boards
  plugins
  Drivers/STM32H7xx_HAL_Driver
lib_extra_dirs =
  .

[common_h723]
lib_deps = Startup723
           ${common.lib_deps}

# Build settings for SD card support
[sdcard]
build_flags =
  -D SDCARD_ENABLE=1
  -I Middlewares/Third_Party/FatFs/src
  -I FATFS/Target
  -I FATFS/App
lib_deps =
  sdcard
  FATFS/App
  FATFS/Target
  Middlewares/Third_Party/FatFs
lib_extra_dirs =

# Build settings for H723 USB serial support
[usb_h723]
build_flags =
  -D USB_SERIAL_CDC=1
  -I Middlewares/ST/STM32_USB_Device_Library/Class/CDC/Inc
  -I Middlewares/ST/STM32_USB_Device_Library/Core/Inc
  -I USB_DEVICE_H723/Target
  -I USB_DEVICE_H723/App
lib_deps =
  USB_DEVICE_H723/App
  USB_DEVICE_H723/Target
  Middlewares/ST/STM32_USB_Device_Library/Class
  Middlewares/ST/STM32_USB_Device_Library/Core
lib_extra_dirs =

# BTT SKR 3 (H723 variant) with USB serial, SD card, and Trinamic 5160 driver support
# 128KB bootloader variant
# Configuration defined in Inc/my_machine.h
[env:btt_skr_30_h723_tmc5160_bl128]
platform = ststm32
board = generic_stm32h723vg
board_build.ldscript = STM32H723VGTX_FLASH_BL.ld
build_flags = ${common.build_flags}
              ${usb_h723.build_flags}
              ${sdcard.build_flags}
  # Hardware-specific: 25MHz external crystal oscillator
  -D HSE_VALUE=25000000
lib_deps = ${common_h723.lib_deps}
           ${usb_h723.lib_deps}
           ${sdcard.lib_deps}
           motors
           trinamic
lib_extra_dirs = ${common.lib_extra_dirs}
                 ${usb_h723.lib_extra_dirs}
                 ${sdcard.lib_extra_dirs}
upload_protocol = dfu
