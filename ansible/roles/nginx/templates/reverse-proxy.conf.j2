{% if nginx_redirect_http_to_https and nginx_ssl_enabled %}
# HTTP server - redirect to HTTPS
server {
    listen {{ nginx_http_port }};
    listen [::]:{{ nginx_http_port }};
    server_name {{ nginx_server_names | join(' ') }};

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$server_name$request_uri;
}
{% endif %}

{% if nginx_ssl_enabled %}
# HTTPS server
server {
    listen {{ nginx_https_port }} ssl;
    listen [::]:{{ nginx_https_port }} ssl;
{% else %}
# HTTP server
server {
    listen {{ nginx_http_port }};
    listen [::]:{{ nginx_http_port }};
{% endif %}
    server_name {{ nginx_server_names | join(' ') }};

{% if nginx_ssl_enabled %}
    # SSL configuration
    ssl_certificate {{ nginx_ssl_cert_path }};
    ssl_certificate_key {{ nginx_ssl_key_path }};

    # SSL protocols and ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

{% endif %}
{% if nginx_security_headers %}
    # Security headers
{% for header in nginx_security_headers %}
    add_header {{ header }};
{% endfor %}

{% endif %}
    # Logging
    access_log {{ nginx_access_log }};
    error_log {{ nginx_error_log }};

    # Client max body size (for file uploads)
    client_max_body_size {{ nginx_client_max_body_size }};

    # Proxy settings
    location / {
        proxy_pass http://{{ nginx_upstream_host }}:{{ nginx_upstream_port }};
        proxy_http_version 1.1;
        
{% if nginx_websocket_support %}
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
{% endif %}
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # Timeouts for long-running connections
        proxy_connect_timeout {{ nginx_proxy_connect_timeout }};
        proxy_send_timeout {{ nginx_proxy_send_timeout }};
        proxy_read_timeout {{ nginx_proxy_read_timeout }};
        
        # Buffering settings
        proxy_buffering {{ nginx_proxy_buffering }};
        proxy_request_buffering {{ nginx_proxy_request_buffering }};
    }
}
