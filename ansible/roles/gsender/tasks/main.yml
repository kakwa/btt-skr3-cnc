---
# Install gSender CNC control software for Raspberry Pi

- name: Install xvfb for virtual X11 display
  apt:
    name: xwayland-run
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: Check if gSender is already installed
  command: dpkg-query -W -f='${Version}' gsender
  register: gsender_installed_version
  failed_when: false
  changed_when: false

- name: Download gSender .deb package
  get_url:
    url: "{{ gsender_deb_url }}"
    dest: "{{ gsender_deb_path }}"
    mode: '0644'
    timeout: 300
  when: gsender_installed_version.rc != 0 or gsender_force_reinstall

- name: Install gSender from .deb package
  apt:
    deb: "{{ gsender_deb_path }}"
    state: present
  when: gsender_installed_version.rc != 0 or gsender_force_reinstall

- name: Display installation status
  debug:
    msg: "gSender {{ gsender_version }} installed successfully"
  when: gsender_installed_version.rc != 0 or gsender_force_reinstall

- name: Display already installed message
  debug:
    msg: "gSender is already installed (version: {{ gsender_installed_version.stdout }})"
  when: gsender_installed_version.rc == 0 and not gsender_force_reinstall

- name: Create gsender system group
  group:
    name: "{{ gsender_group }}"
    system: yes
    state: present

- name: Create gsender system user
  user:
    name: "{{ gsender_user }}"
    group: "{{ gsender_group }}"
    groups: dialout,video
    system: yes
    create_home: yes
    home: "{{ gsender_home }}"
    shell: /usr/sbin/nologin
    comment: "gSender CNC Control Service User"
    state: present

- name: Create gsender systemd service file
  template:
    src: gsender.service.j2
    dest: /etc/systemd/system/gsender.service
    owner: root
    group: root
    mode: '0644'
  notify: restart gsender

- name: Enable and start gsender service
  systemd:
    name: gsender
    enabled: yes
    state: started
    daemon_reload: yes

# Avahi service announcement
- name: Install avahi-daemon
  apt:
    name:
      - avahi-daemon
      - avahi-utils
    state: present
    update_cache: yes
    cache_valid_time: 3600
  when: gsender_enable_avahi

- name: Create Avahi service file for gSender
  template:
    src: gsender.avahi-service.j2
    dest: /etc/avahi/services/gsender.service
    owner: root
    group: root
    mode: '0644'
  notify: restart avahi-daemon
  when: gsender_enable_avahi

- name: Enable and start avahi-daemon
  systemd:
    name: avahi-daemon
    enabled: yes
    state: started
  when: gsender_enable_avahi
